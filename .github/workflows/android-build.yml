name: Android CI Build

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Choose build type: debug or release'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    # ANDROID_SDK_ROOT is set at runtime using the runner-provided $RUNNER_TEMP
    # (we export it into GITHUB_ENV in the step below so it's available to later steps)

    steps:
      - name: Checkout repository
        run: |
          set -eux
          # clone repository into the workspace using the workflow token
          git clone --depth=1 "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}" .

      - name: Set Android SDK root
        run: |
          echo "ANDROID_SDK_ROOT=$RUNNER_TEMP/android-sdk" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          set -eux
          # Try a clean CI install first; if it fails, fall back to a regular install which is more lenient
          npm ci --prefer-offline --no-audit || npm install --prefer-offline --no-audit

      - name: Build web and copy to Android/www
        run: npm run android:prepare

      - name: Setup Java (for Gradle)
        uses: ./.github/actions/setup-java

      - name: Install Android SDK command-line tools
        run: |
          set -eux
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          # Try several known commandlinetools filenames (some runners/regions may 404 on 'latest')
          URLS=(
            "https://dl.google.com/android/repository/commandlinetools-linux-latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-9123335_latest.zip"
            "https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip"
          )
          SUCCESS=0
          for u in "${URLS[@]}"; do
            echo "Trying $u"
            if curl --retry 3 --retry-delay 5 -fSL -o cmdline-tools.zip "$u"; then
              SUCCESS=1
              echo "Downloaded from $u"
              break
            else
              echo "Download failed for $u, trying next..."
            fi
          done
          if [ "$SUCCESS" -ne 1 ]; then
            echo "Unable to download any commandline tools from known URLs" >&2
            exit 22
          fi
          # Basic validation: ensure we downloaded a reasonably sized file (>= 1MB)
          FILESIZE=$(stat -c%s cmdline-tools.zip || echo 0)
          if [ "$FILESIZE" -lt 1000000 ]; then
            echo "Downloaded file is too small ($FILESIZE bytes); printing head for diagnosis:" >&2
            head -n 200 cmdline-tools.zip | sed -n '1,200p' >&2 || true
            exit 9
          fi
          unzip -q cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
          # Move to 'latest' folder if needed
          if [ -d "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" ]; then
            mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          fi
          rm cmdline-tools.zip
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" "platform-tools" "platforms;android-33" "build-tools;33.0.2"

      - name: Ensure Capacitor Android platform exists and sync
        run: |
          set -eux
          if [ -d android ]; then
            npm exec -- cap sync android
          else
            npm exec -- cap add android
            npm exec -- cap sync android
          fi

      - name: Build APK (debug)
        if: ${{ github.event.inputs.build_type == 'debug' || github.event_name == 'push' }}
        run: |
          set -eux
          cd android
          ./gradlew assembleDebug --no-daemon
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}

      - name: Upload debug APK artifact
        if: ${{ github.event.inputs.build_type == 'debug' || github.event_name == 'push' }}
        uses: ./.github/actions/upload-artifact
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: debug
          path: android/app/build/outputs/apk/debug/app-debug.apk

      - name: Prepare release keystore (if requested)
        if: ${{ github.event.inputs.build_type == 'release' }}
        run: |
          set -eux
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "Decoding keystore..."
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/my-release-key.jks
            cat > android/keystore.properties <<EOF
            storeFile=android/app/my-release-key.jks
            storePassword=${{ secrets.KEYSTORE_PASSWORD }}
            keyAlias=${{ secrets.KEYSTORE_ALIAS }}
            keyPassword=${{ secrets.KEY_PASSWORD }}
            EOF
          else
            echo "No KEYSTORE_BASE64 secret found. Building unsigned release (skipping signing)."
          fi

      - name: Build APK (release)
        if: ${{ github.event.inputs.build_type == 'release' }}
        run: |
          set -eux
          cd android
          ./gradlew assembleRelease --no-daemon
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}

      - name: Upload release APK artifact
        if: ${{ github.event.inputs.build_type == 'release' }}
        uses: ./.github/actions/upload-artifact
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: release
          path: android/app/build/outputs/apk/release/*.apk
